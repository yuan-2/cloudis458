<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Medilab Bootstrap Template - Index</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Medilab - v4.7.0
  * Template URL: https://bootstrapmade.com/medilab-free-medical-bootstrap-theme/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body onload="checkLogin()">

  <!-- ======= Top Bar ======= -->
  <div id="topbar" class="d-flex align-items-center fixed-top">
    <div class="container d-flex justify-content-between">
      <div class="contact-info d-flex align-items-center">
        <i class="bi bi-envelope"></i> <a href="mailto:tsrainingraincoats@gmail.com">itsrainingraincoats@gmail.com</a>
      </div>
      <div class="d-none d-lg-flex social-links align-items-center">
        <a href="https://www.facebook.com/itsrainingraincoats/" class="facebook"><i class="bi bi-facebook"></i></a>
        <a href="https://www.instagram.com/itsrainingraincoats/" class="instagram"><i class="bi bi-instagram"></i></a>
        <a href="https://www.linkedin.com/company/itsrainingraincoats/?originalSubdomain=sg" class="linkedin"><i
            class="bi bi-linkedin"></i></i></a>
      </div>
    </div>
  </div>

  <!-- ======= Nav Bar ======= -->
  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center">

      <h1 class="logo me-auto"><a href="index.html"></a></h1>
      <!-- Uncomment below if you prefer to use an image logo -->
      <!-- <a href="index.html" class="logo me-auto"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->

      <nav id="navbar" class="navbar order-last order-lg-0">
        <ul>
          <li><a class="nav-link scrollto active" href="index.html">Home</a></li>
          <li><a class="nav-link scrollto" href="donateGeneral.html">Donate</a></li>
          <li><a class="nav-link scrollto" href="requestWishList.html">Request</a></li>
          <li><a class="nav-link scrollto" href="faq.html">Help</a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->
      <a id="loginLogoutButton" onclick="loginLogout()" style="cursor: pointer;"
        class="appointment-btn scrollto">Login</a>

    </div>
  </header><!-- End Header -->

  <!-- ======= Image Banner Section ======= -->
  <section id="hero" class="d-flex align-items-center"></section>
  <!-- End Hero -->

  <main id="main">

    <!-- ======= Carousel Section ======= -->
    <section id="carouselheader" class="carouselheader">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 col-sm-12">
            <h2>Welcome to iMatch</h2>
            <p style="font-style: italic">Find the items you need here</p>

            <!-- search box for categories, add onchange event here -->
            <div>
              <div id="catDropdown">
                <label for="catSearchList" class="form-label pt-3">Category:</label>
                <select onchange="populateSubCat(this)" class="form-select" style="width: 50%;" id="catSearchList"
                  name="catSearch">
                  <!--Dynamically dropdown categories listed in existing db-->
                </select>
              </div>
              <div id="itemDropdown">
                <label for="subCatList" class="form-label pt-3">Sub-Category:</label>
                <select onchange="filter()" class="form-select" style="width: 50%;" id="subCatList" name="subCatSearch">
                  <!--Update items found based on above dropdown-->
                </select>
              </div>
            </div>

          </div>
          <!-- wishlist starts here (auto populate using db) -->
          <div class="col-lg-6 col-sm-12" id="table-wrapper">
            <h2 class="text-center">Wishlist</h2>
            <table id="wishListTable"
              class="table table-hover float-end text-center d-none table-bordered border border-2">
            </table>
            <p id="emptyWLDisplay" class="text-center d-none">There are currently no items in the WishList</p>
          </div>
          <!-- wishlist ends here -->
        </div>
      </div>
      <!-- item carousel starts here (auto populate using db) -->
      <section id="carouselBody">
        <div class="container">
          <div class="row" id="mainCarouselDisplay">
            <!-- Div for carousel cards go here -->
          </div>
        </div>
      </section>
      <!-- End Carousel Body Section -->

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">

    <div class="footer-top">
      <div class="container">
        <div class="row">

          <div class="col-lg-3 col-md-6 footer-contact">
            <h3>Medilab</h3>
            <p>
              A108 Adam Street <br>
              New York, NY 535022<br>
              United States <br><br>
              <strong>Phone:</strong> +1 5589 55488 55<br>
              <strong>Email:</strong> info@example.com<br>
            </p>
          </div>

          <div class="col-lg-2 col-md-6 footer-links">
            <h4>Useful Links</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Home</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">About us</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Services</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Terms of service</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Privacy policy</a></li>
            </ul>
          </div>

          <div class="col-lg-3 col-md-6 footer-links">
            <h4>Our Services</h4>
            <ul>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Web Design</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Web Development</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Product Management</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Marketing</a></li>
              <li><i class="bx bx-chevron-right"></i> <a href="#">Graphic Design</a></li>
            </ul>
          </div>

          <div class="col-lg-4 col-md-6 footer-newsletter">
            <h4>Join Our Newsletter</h4>
            <p>Tamen quem nulla quae legam multos aute sint culpa legam noster magna</p>
            <form action="" method="post">
              <input type="email" name="email"><input type="submit" value="Subscribe">
            </form>
          </div>

        </div>
      </div>
    </div>

    <div class="container d-md-flex py-4">

      <div class="me-md-auto text-center text-md-start">
        <div class="copyright">
          &copy; Copyright <strong><span>Medilab</span></strong>. All Rights Reserved
        </div>
        <div class="credits">
          <!-- All the links in the footer should remain intact. -->
          <!-- You can delete the links only if you purchased the pro version. -->
          <!-- Licensing information: https://bootstrapmade.com/license/ -->
          <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/medilab-free-medical-bootstrap-theme/ -->
          Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
        </div>
      </div>
      <div class="social-links text-center text-md-right pt-3 pt-md-0">
        <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
        <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
        <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
        <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
        <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <div id="preloader"></div>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/purecounter/purecounter.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

  <script>
    var user = ""

    var mainCarouselDisplay = document.getElementById("mainCarouselDisplay")
    var wishListTable = document.getElementById('wishListTable')
    var emptyWLDisplay = document.getElementById('emptyWLDisplay')

    // DataList display
    var catSearchList = document.getElementById('catSearchList')
    var subCatList = document.getElementById('subCatList')

    function checkLogin() {
      if (sessionStorage.getItem("user") != null) {
        user = JSON.parse(sessionStorage.getItem("user"))
        // console.log(JSON.parse(user))

        document.getElementById("loginLogoutButton").innerText = "Logout"
      }

      // async to return promise and update carousel page with items 
      loadCarousel().then(function retrieveItems(result) {
        mainCarouselDisplay.innerHTML = ""

        if (result == "Empty") {
          mainCarouselDisplay.innerHTML =
            "<div class='text-center alert alert-warning rounded-3' style='height: 120px'> <p class='mt-3'> There are no items available for request at the moment, please try again later </p> </div>"
        } else {
          var carouselItemList = result
          let itemCheck = []
          for (i in carouselItemList) {
            // variable to check if carousel has items, if no items smaller than expiry date, display another div instead
            date = new Date(carouselItemList[i].timeSubmitted);
            lastDate = date.setDate(date.getDate() + 1);
            dateNow = Date.now();
            // if current date is earlier/smaller than expiry date
            if ((dateNow - lastDate) < 0) {
              itemCheck.push(carouselItemList[i])

              if (itemCheck.length > 0) {
                mainCarouselDisplay.innerHTML += `
                <div class="col-lg-4 d-flex align-items-stretch p-3 rounded-2">
                <div class="card" style="width: 20rem;">
                    <img src="./assets/img/donations/${carouselItemList[i].fileName}" class="card-img-top" alt="...">
                    <div class="card-content">
                      <div class="card-body">
                        <h5 class="card-title">Item Name: ${carouselItemList[i].itemName}</h5>
                        <h6 class="card-subtitle mb-2">Category: ${carouselItemList[i].category}</h6>
                        <h6 class="card-subtitle">Sub-Category: ${carouselItemList[i].subcat}</h6>
                        <a data-tip="${carouselItemList[i].id}" onclick="checkUserType(this)" class="btn btn-primary">Request</a>
                      </div>
                    </div>
                </div>
                </div>
            `
              } else {
                mainCarouselDisplay.innerHTML =
                  "<div class='text-center alert alert-warning rounded-3' style='height: 120px'> <p class='mt-3'> There are no items available for request at the moment, please try again later </p> </div>"
              }
            }
          }
        }


      })

      loadWishList().then(function getWishList(result) {
        var wishListItems = result
        // console.log(wishListItems)

        // Reset Table when page refreshes
        wishListTable.innerHTML = ""

        // Check if wishlist has items within it
        if (Object.keys(wishListItems).length > 0) {

          wishListTable.classList.remove('d-none')
          emptyWLDisplay.classList.remove('d-block')
          emptyWLDisplay.classList.add('d-none')

          wishListTable.innerHTML = `<tr>
                <th>Item Name</th>
                <th>Quantity</th>
              </tr>`

          for (let i in wishListItems) {
            wishListTable.innerHTML += `
            <tr>
              <td>${wishListItems[i].itemName}</td>
              <td>${wishListItems[i].quantity}</td>
            </tr>
            `
          }
        } else {
          wishListTable.classList.add('d-none')
          emptyWLDisplay.classList.add('d-block')
          emptyWLDisplay.classList.remove('d-none')
        }
      })
      // Function to retrieve Categories for dropdown
      getDropDownCat().then(function autoPopCategories(result) {
        var catList = result

        // reset search fields
        catSearchList.innerHTML = ""

        subCatList.innerHTML = ""

        // Add a default empty selection
        catSearchList.innerHTML = "<option selected> </option>"

        for (cat of catList) {
          catSearchList.innerHTML += `
                        <option value="${cat}">${cat}</option>
                    `
        }
      })
    }

    // Function to load donations
    async function loadCarousel() {
      try {
        let response = await fetch("http://127.0.0.1:5004/getItems")
        let responseCode = await response.json()
        if (responseCode.code == 200) {
          return responseCode.data.items
        } else {
          return "Empty"
        }
      } catch (error) {
        alert(error)
      }
    }

    // Function to view wishlist items
    async function loadWishList() {
      try {
        let response = await fetch("http://127.0.0.1:5004/getWL")
        let responseCode = await response.json()
        if (responseCode.code == 200) {
          return responseCode.data.items
        }
      } catch (error) {
        alert(error)
      }
    }
    // Async function for Search Dropdown (Index Page)
    async function getDropDownCat() {
      let response = await fetch("http://127.0.0.1:5004/getCat")
      let responseCode = await response.json()

      if (responseCode.code == 200) {
        return responseCode.data.categories
      } else {
        alert(responseCode.message)
      }
    }

    // async function populateItemNames(cat) {
    //   itemSearchList.innerHTML = ""
    //   itemSearchList.innerHTML = "<option selected> Please select a Category above </option>"
    //   cat = cat.value
    //   let response = await fetch("http://127.0.0.1:5004/getItemsInCat/" + cat)
    //   let responseCode = await response.json()

    //   if (responseCode.code == 200) {
    //     for (cat of responseCode.data.itemsInCat) {
    //       itemSearchList.innerHTML += `<option value="${cat.itemName}">${cat.itemName}</option>`
    //     }
    //   }
    // }

    async function populateSubCat(cat) {
      subCatList.innerHTML = ""
      cat = cat.value
      let response = await fetch("http://127.0.0.1:5004/getSubCat/" + cat)
      let responseCode = await response.json()

      if (responseCode.code == 200) {
        subCatList.innerHTML += "<option selected> </option>"
        let subCatArr = []
        for (subcat of responseCode.data.subcats) {
          if (!subCatArr.includes(subcat.subCat)) {
            subCatArr.push(subcat.subCat)
          }
        }
        for (sub of subCatArr) {
          subCatList.innerHTML += `<option value="${sub}">${sub}</option>`
        }
      }
    }

    function loginLogout() {
      if (document.getElementById("loginLogoutButton").innerText === "Login") {
        window.location.href = "login.html"
      } else {
        // user = ""
        sessionStorage.removeItem("user")
        window.location.reload()
      }
    }

    // Search function on Cat & Sub Cat once Sub Cat is selected
    async function filter() {
      let subCatVal = subCatList.value

      let response = await fetch("http://127.0.0.1:5004/getItemsBySubCat/" + subCatVal)
      let responseCode = await response.json()

      if (responseCode.code == 200) {
        mainCarouselDisplay.innerHTML = ""
        let itemCheck = []
        for (item of responseCode.data.items) {
          date = new Date(item.timeSubmitted);
          lastDate = date.setDate(date.getDate() + 1);
          dateNow = Date.now();
          // if current date is earlier/smaller than expiry date
          if ((dateNow - lastDate) < 0) {
            itemCheck.push(item)

            if (itemCheck.length > 0) {
              mainCarouselDisplay.innerHTML += `
                <div class="col-lg-4 d-flex align-items-stretch p-3 rounded-2">
                <div class="card" style="width: 20rem;">
                    <img src="./assets/img/donations/${item.fileName}" class="card-img-top" alt="...">
                    <div class="card-content">
                      <div class="card-body">
                        <h5 class="card-title">${item.itemName}</h5>
                        <h6 class="card-subtitle mb-2">${item.category}</h6>
                        <h6 class="card-subtitle">${item.subcat}</h6>
                        <a data-tip="${item.id}" onclick="checkUserType(this)" class="btn btn-primary">Request</a>
                      </div>
                    </div>
                </div>
                </div>
            `
            } else {
              mainCarouselDisplay.innerHTML =
                "<div class='text-center alert alert-warning rounded-3' style='height: 120px'> <p class='mt-3'> There are no items available for request at the moment, please try again later </p> </div>"
            }
          }
        }
      } else {
        mainCarouselDisplay.innerHTML =
          "<div class='text-center alert alert-warning rounded-3' style='height: 120px'> <p class='mt-3'> There are no items available for request at the moment, please try again later </p> </div>"
      }
    }

    function checkUserType(x) {
      var itemData = x.getAttribute("data-tip")

      if (user == "") {
        let confirmMsg = confirm(
          "Only Migrant Workers who are logged in are able to request for items, click 'Ok' to go to the Login Page.")

        if (confirmMsg == true) {
          window.location.href = "login.html"
        }

      } else if (user.userType == "worker") {
        if (dateNow - lastDate < 0) {
          window.location.href =
            `requestItemPage.html?id=${itemData}` // pass itemId over to request page to retrieve full item info
        } else {
          alert("This item has expired. Please refresh the page to see the list of items available.")
        }
        // console.log(itemData)
      }
    }
  </script>

</body>

</html>